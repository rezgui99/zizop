<div class="p-6">
  <h2 class="text-3xl font-bold text-primary mb-6">Fiches de Poste</h2>

  <!-- Filtres et recherche -->
  <div class="card mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-gray-700 text-sm font-bold mb-2">Recherche</label>
        <input type="text" [(ngModel)]="searchQuery" (input)="onSearchChange()" 
               placeholder="Rechercher..." 
               class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
      </div>
      <div>
        <label class="block text-gray-700 text-sm font-bold mb-2">Filière</label>
        <select [(ngModel)]="selectedFiliere" (change)="onFilterChange()" 
                class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">Toutes les filières</option>
          <option *ngFor="let filiere of filiereOptions" [value]="filiere">{{ filiere }}</option>
        </select>
      </div>
      <div>
        <label class="block text-gray-700 text-sm font-bold mb-2">Famille</label>
        <select [(ngModel)]="selectedFamille" (change)="onFilterChange()" 
                class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
          <option value="">Toutes les familles</option>
          <option *ngFor="let famille of familleOptions" [value]="famille">{{ famille }}</option>
        </select>
      </div>
      <div class="flex items-end">
        <button (click)="clearFilters()" class="btn btn-secondary w-full">Effacer filtres</button>
      </div>
    </div>
  </div>

  <!-- Bouton d'ajout -->
  <div class="mb-4">
    <button (click)="showAddForm = !showAddForm" class="btn btn-primary">
      {{ showAddForm ? 'Annuler' : 'Ajouter une fiche de poste' }}
    </button>
  </div>

  <!-- Messages d'erreur -->
  <div *ngIf="errorMessage" class="mb-4 p-3 bg-red-100 text-red-700 rounded-md">
    {{ errorMessage }}
  </div>

  <!-- Formulaire d'ajout/modification -->
  <div *ngIf="showAddForm || editingJobDescription" class="card mb-6">
    <h3 class="text-xl font-semibold text-dark mb-4">
      {{ editingJobDescription ? 'Modifier la fiche de poste' : 'Nouvelle fiche de poste' }}
    </h3>
    
    <form [formGroup]="jobDescriptionForm" (ngSubmit)="onSubmit()">
      <!-- Informations de base -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Emploi *</label>
          <input type="text" formControlName="emploi" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Filière d'activité *</label>
          <input type="text" formControlName="filiere_activite" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Famille *</label>
          <input type="text" formControlName="famille" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
      </div>

      <!-- Supérieurs hiérarchiques -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Supérieur N1</label>
          <select formControlName="superieur_n1" 
                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">-- Aucun --</option>
            <option *ngFor="let job of jobDescriptions" [value]="job.id">
              {{ job.emploi }} - {{ job.filiere_activite }}
            </option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Supérieur N2</label>
          <select formControlName="superieur_n2" 
                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="">-- Aucun --</option>
            <option *ngFor="let job of jobDescriptions" [value]="job.id">
              {{ job.emploi }} - {{ job.filiere_activite }}
            </option>
          </select>
        </div>
      </div>

      <!-- Détails du poste -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Niveau d'exigence</label>
          <input type="text" formControlName="niveau_exigence" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Niveau d'expérience</label>
          <input type="text" formControlName="niveau_exp" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Statut</label>
          <select formControlName="status" 
                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <option value="Actif">Actif</option>
            <option value="Inactif">Inactif</option>
            <option value="Brouillon">Brouillon</option>
          </select>
        </div>
        <div>
          <label class="block text-gray-700 text-sm font-bold mb-2">Version</label>
          <input type="text" formControlName="version" 
                 class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
        </div>
      </div>

      <!-- Finalité -->
      <div class="mb-6">
        <label class="block text-gray-700 text-sm font-bold mb-2">Finalité</label>
        <textarea formControlName="finalite" rows="3" 
                  class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
      </div>

      <!-- Missions -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h4 class="text-lg font-semibold text-dark">Missions</h4>
          <button type="button" (click)="addMission()" class="btn btn-secondary">Ajouter mission</button>
        </div>
        <div formArrayName="missions" class="space-y-2">
          <div *ngFor="let mission of missionsArray.controls; let i = index" [formGroupName]="i" 
               class="flex items-center space-x-2">
            <input type="text" formControlName="name" placeholder="Description de la mission" 
                   class="flex-1 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <button type="button" (click)="removeMission(i)" 
                    class="btn bg-red-500 text-white hover:bg-red-600">Supprimer</button>
          </div>
        </div>
      </div>

      <!-- Moyens -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h4 class="text-lg font-semibold text-dark">Moyens</h4>
          <button type="button" (click)="addMoyen()" class="btn btn-secondary">Ajouter moyen</button>
        </div>
        <div formArrayName="moyens" class="space-y-2">
          <div *ngFor="let moyen of moyensArray.controls; let i = index" [formGroupName]="i" 
               class="flex items-center space-x-2">
            <input type="text" formControlName="name" placeholder="Description du moyen" 
                   class="flex-1 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <button type="button" (click)="removeMoyen(i)" 
                    class="btn bg-red-500 text-white hover:bg-red-600">Supprimer</button>
          </div>
        </div>
      </div>

      <!-- Aires de proximité -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h4 class="text-lg font-semibold text-dark">Aires de proximité</h4>
          <button type="button" (click)="addAireProximite()" class="btn btn-secondary">Ajouter aire</button>
        </div>
        <div formArrayName="airesProximites" class="space-y-2">
          <div *ngFor="let aire of airesProximiteArray.controls; let i = index" [formGroupName]="i" 
               class="flex items-center space-x-2">
            <input type="text" formControlName="name" placeholder="Nom de l'aire de proximité" 
                   class="flex-1 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <input type="number" formControlName="nombre" min="1" placeholder="Nombre" 
                   class="w-20 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
            <button type="button" (click)="removeAireProximite(i)" 
                    class="btn bg-red-500 text-white hover:bg-red-600">Supprimer</button>
          </div>
        </div>
      </div>

      <!-- Compétences requises -->
      <div class="mb-6">
        <div class="flex justify-between items-center mb-3">
          <h4 class="text-lg font-semibold text-dark">Compétences requises</h4>
          <button type="button" (click)="addRequiredSkill()" class="btn btn-secondary">Ajouter compétence</button>
        </div>
        <div formArrayName="requiredSkills" class="space-y-2">
          <div *ngFor="let skill of requiredSkillsArray.controls; let i = index" [formGroupName]="i" 
               class="flex items-center space-x-2">
            <select formControlName="skill_id" 
                    class="flex-1 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="">Sélectionner une compétence</option>
              <option *ngFor="let skill of skills" [value]="skill.id">{{ skill.name }}</option>
            </select>
            <select formControlName="required_skill_level_id" 
                    class="flex-1 px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
              <option value="">Sélectionner un niveau</option>
              <option *ngFor="let level of skillLevels" [value]="level.id">{{ level.level_name }}</option>
            </select>
            <button type="button" (click)="removeRequiredSkill(i)" 
                    class="btn bg-red-500 text-white hover:bg-red-600">Supprimer</button>
          </div>
        </div>
      </div>

      <!-- Boutons d'action -->
      <div class="flex gap-2">
        <button type="submit" [disabled]="!jobDescriptionForm.valid" class="btn btn-primary">
          {{ editingJobDescription ? 'Mettre à jour' : 'Créer' }}
        </button>
        <button type="button" (click)="cancelEdit()" class="btn btn-secondary">
          Annuler
        </button>
      </div>
    </form>
  </div>

  <!-- Liste des fiches de poste -->
  <div class="card">
    <div *ngIf="loading" class="text-center text-primary py-8">
      Chargement des fiches de poste...
    </div>

    <div *ngIf="!loading && filteredJobDescriptions.length === 0" class="text-center text-gray-600 py-8">
      Aucune fiche de poste trouvée.
    </div>

    <div *ngIf="!loading && filteredJobDescriptions.length > 0" class="overflow-x-auto">
      <table class="min-w-full table-auto">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Emploi</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Filière</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Famille</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supérieur N1</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supérieur N2</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Détails</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let job of filteredJobDescriptions" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ job.emploi }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ job.filiere_activite }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ job.famille }}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <span *ngIf="job.superieur_n1" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ getSuperieurName(job.superieur_n1) }}
              </span>
              <span *ngIf="!job.superieur_n1" class="text-gray-400">Aucun</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <span *ngIf="job.superieur_n2" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                {{ getSuperieurName(job.superieur_n2) }}
              </span>
              <span *ngIf="!job.superieur_n2" class="text-gray-400">Aucun</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <span [class]="job.status === 'Actif' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" 
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                {{ job.status }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              <div class="flex space-x-1">
                <span *ngIf="job.missions && job.missions.length > 0" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  {{ job.missions.length }} missions
                </span>
                <span *ngIf="job.moyens && job.moyens.length > 0" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  {{ job.moyens.length }} moyens
                </span>
                <span *ngIf="job.requiredSkills && job.requiredSkills.length > 0" 
                      class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                  {{ job.requiredSkills.length }} compétences
                </span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <button (click)="navigateToMatching(job.id!)" class="text-green-600 hover:text-green-900 mr-3">Matching</button>
              <button (click)="editJobDescription(job)" class="text-primary hover:text-blue-700 mr-3">Modifier</button>
              <button (click)="deleteJobDescription(job)" class="text-red-600 hover:text-red-900">Supprimer</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>